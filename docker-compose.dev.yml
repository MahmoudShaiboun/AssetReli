version: '3.8'

services:
  # MongoDB Database
  mongodb:
    extends:
      file: docker-compose.yml
      service: mongodb

  mqtt-broker:
    extends:
      file: docker-compose.yml
      service: mqtt-broker

  reli-postgres:
    extends:
      file: docker-compose.yml
      service: reli-postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres-config/pg_hba.conf:/var/lib/postgresql/data/pg_hba.conf
    extra_hosts:
      - "host.docker.internal:host-gateway"

  ml-service:
    extends:
      file: docker-compose.yml
      service: ml-service
    environment:
      - MONGODB_URL=mongodb://mongodb:27017
      - POSTGRES_URL=postgresql+asyncpg://aastreli:${POSTGRES_PASSWORD:-aastreli_dev}@reli-postgres:5432/aastreli

  mqtt-ingestion:
    extends:
      file: docker-compose.yml
      service: mqtt-ingestion
    environment:
      - MONGODB_URL=mongodb://mongodb:27017
      - POSTGRES_URL=postgresql+asyncpg://aastreli:${POSTGRES_PASSWORD:-aastreli_dev}@reli-postgres:5432/aastreli

  backend-api:
    extends:
      file: docker-compose.yml
      service: backend-api
    environment:
      - MONGODB_URL=mongodb://mongodb:27017
      - ML_SERVICE_URL=http://ml-service:8001
      - MQTT_SERVICE_URL=http://mqtt-ingestion:8002
      - POSTGRES_URL=postgresql+asyncpg://aastreli:${POSTGRES_PASSWORD:-aastreli_dev}@reli-postgres:5432/aastreli

  frontend:
    extends:
      file: docker-compose.yml
      service: frontend
    environment:
      - REACT_APP_API_URL=http://localhost:8000
      - REACT_APP_WS_URL=ws://localhost:8002

networks:
  aastreli-network:
    driver: bridge

volumes:
  mongodb_data:
  postgres_data:
  mqtt_data:
  mqtt_logs:
